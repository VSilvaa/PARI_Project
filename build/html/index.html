<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Projeto_Final__PARI_2016/2017: Desenvolvimento de Interface Gráfica em Comunicação com um Sistema Remoto</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_1.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="robot.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Projeto_Final__PARI_2016/2017
   &#160;<span id="projectnumber">5.5.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Desenvolvimento de Interface Gráfica em Comunicação com um Sistema Remoto </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="DescricaoGeral_sec"></a>
Descrição Geral</h1>
<p>No âmbito da unidade curricular de Projeto em Automação e Robótica Industrial, como projeto final, foi proposto o desenvolvimento de uma interface gráfica em GTK que interagisse com um utilizador. A interface deverá representar, em tempo real, informações remotas recolhidas de um sistema remoto, deverá ainda ter a capacidade de controlar outras grandezas do mesmo sistema. Para tal é necessário estabelecer uma comunicação entre a interface e o sistema remoto num suporte RS232 ou TCP/IP. Deverá ser desenvolvida na linguagem de programação C e utilizar o ambiente de compilação CMake.</p>
<dl class="section author"><dt>Author</dt><dd>Vítor Augusto Silva 67612</dd></dl>
<h1><a class="anchor" id="DescricaoProjeto_sec"></a>
Descrição do Projeto</h1>
<p>Dadas as circunstâncias pensou-se em desenvolver uma interface em GTK 3.0 para controlo e monitorização do Robot Fanuc LR Mate 200 iD que será um dos objetos de estudo do autor no seu tema de dissertação. A aplicação deveria ser capaz de ler o valor das juntas e/ou coordenadas absolutas e monitorizar o estado de saídas digitais específicas. Associado ao controlo, deveria ainda executar determinados programas em linguagem TP previamente criados no controlador do robot e enviar o robot para determinados valores de juntas ou coordenadas absolutas. Para que isto fosse possível teria que se comunicar em tempo real com o controlador do referido robot. A comunicação utilizaria o protocolo ModBus TCP/IP para, desta forma, trocar informações entre interface e o sistema remoto. Acontece que o referido robot presente no Laboratório de Automação e Robótica não tem implementado o protocolo que se pretendia utilizar. A alternativa passava por usar um simulador (Roboguide) em que o protocolo é de fácil implementação e é possível a simulação de todas as funções do robot e seu controlador, no entanto, o simulador foi desenvolvido para para o sistema operativo windows, usa portas default que não são configuráveis e só é possível aceder ao software através de ip's internos o que inviabilizou a sua utilização. Como tal optou-se por utilizar um servidor ModBus genérico com a porta configurável que permite a utilização de todas as funções suportadas pelo ModBus e simula perfeitamente o servidor Modbus que se pretendia aceder no controlador ou no software Roboguide.</p>
<h1><a class="anchor" id="Protocolo_sec"></a>
Protocolo ModBus TCP/IP</h1>
<p>Dado que este protocolo é o único meio de troca de informação entre a aplicação desenvolvida e a unidade remota importa dar a conhecer um pouco sobre a sua estrutura das mensagens trocadas em suporte físico Ethernet e ainda a estrutura das mensagens ModBus TCP/IP em específico. As imagens que se seguem ilustram as referidas estruturas, respetivamente.</p>
<div class="image">
<img src="mod1.PNG" alt="mod1.PNG"/>
<div class="caption">
Costrução dum pacote de dados TCP/IP - Ethernet</div></div>
<p> Como podemos ver na figura cada mensagem transferida no meio físico Ethernet e inserida no protocolo TCP/IP tem encapsuladas várias camadas ou sub mensagens. Cada uma dessas camadas tem informações diferentes como por exemplo o ip ou a porta a quem se destina a mensagem.</p>
<div class="image">
<img src="mod2.jpg" alt="mod2.jpg"/>
<div class="caption">
Construção dum pacote de dados ModBus TCP/IP</div></div>
<p> A imagem anterior mostra a estrutura de uma mensagem MosBus TCP/IP que fica inserida na primeira camada (ADU - Application Data Unit) do pacote de dados Ethernet. Para efetivar a comunicação que era necessária ao trabalho foi importante perceber esta estrutura e suas pequenas variâncias. Só dessa forma foi possível a criação de uma biblioteca de geração de mensagens que quando lidas pelo servidor ModBus desempenhavam funções espeçíficas como alterar o estado de variáveis booleanas ou retornar determinados valores de registos.</p>
<h1><a class="anchor" id="Arquitetura_sec"></a>
Arquitetura do Programa</h1>
<p>O programa é constituído por dois ficheiros com código fonte <a class="el" href="main_8c.html" title="Ficheiro principal do código fonte utilizado na realização do projeto final da unidade corricular de ...">main.c</a> e <a class="el" href="callbacks_8c.html" title="Ficheiro de suporte ao main.c, contém todas as funções e sinais que não estão comtemplados na bibliot...">callbacks.c</a> e por uma header file <a class="el" href="myf_8h_source.html">myf.h</a>. A melhor arquitetura encontrada para a realização deste projeto foi a utilização de dois processos, um responsável por mostrar a interface e encaminhar todos os eventos gerados para as callbacks correspondentes (processo pai) e outro responsável pela comunicação entre a aplicação e o sistema remoto (processo filho). O segundo apenas é chamado aquando o utilizador prime o botão Connect, iniciando nesse instante o processo e a comunicação. Os processos estão ligados por uma memória partilhada que tem a função de ligar os referidos processos através da leitura e escrita organizada da memória. Ambos os processos utilizam a biblioteca VS_Modbus, desenvolvida pelo autor, e que está encarregue de diversas funções descritas de seguida. Uma particularidade discutível do código do projeto é que o botão 6 (Connect) do ficheiro <a class="el" href="callbacks_8c.html" title="Ficheiro de suporte ao main.c, contém todas as funções e sinais que não estão comtemplados na bibliot...">callbacks.c</a> é responsável pela biforcação dos processos ficando um responsável pela interface e o segundo (filho) responsável pela ligação tcp/ip ao servidor modbus. Deste modo o botão 6 fica responsável por importantes tarefas. O autor optou por não passar nem a criação da memória partilhada nem o estabelecimento da ligação tcp/ip para funções pois, desta forma, teria que se criar um novo ficheiro de suporte ao <a class="el" href="main_8c.html" title="Ficheiro principal do código fonte utilizado na realização do projeto final da unidade corricular de ...">main.c</a> com apenas essas funções ou incluir as referidas funções na biblioteca gerada, o que não seria uma boa prática pois ficaria com imensos parâmetros de entrada. Pensou-se que a iclusão de todo o código responsável pela biforcação de processos, criação da shared memory e estabelecimento de ligação tcp/ip deveria estar incluído diretamente na callback pois desta forma ficava mais claro para um leitor que fosse analisar o código ou alterá-lo. Como ponto negativo a callback associada ao clique no botão 6 ficou bastante extensa o que diverge as opiniões de programador para programador.</p>
<p>O diagrama seguinte sintetiza a descrição efetuada. </p><div class="image">
<img src="arq.png" alt="arq.png"/>
<div class="caption">
Diagrama ilustratido da Arquitetura do programa</div></div>
 <h1><a class="anchor" id="Memória_sec"></a>
Memória Partilhada</h1>
<p>Para estabelecer a ligação entre os dois processos foi necessária a criação de uma memória partilhada pelos dois processos. Ambos podem ler e escrever dentro dessa memória e desta forma, num processo organizado de leitura e escrita dos processos nessa memória consegue-se estabelecer uma espécie de comunicação e o armazenamento de dados partilhados ao mesmo tempo. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{  <span class="comment">// Final Project Struct - Client Modbus TCP/IP</span></div><div class="line">    <span class="keywordtype">char</span> moving;</div><div class="line">    <span class="keywordtype">char</span> prg; </div><div class="line">    <span class="keywordtype">char</span> mvjoints;</div><div class="line">    <span class="keywordtype">char</span> mvabs;</div><div class="line">    <span class="keywordtype">char</span> mvprg;</div><div class="line">    <span class="keywordtype">char</span> gtjoints;</div><div class="line">    <span class="keywordtype">char</span> gtabs;</div><div class="line">    <span class="keywordtype">char</span> connected;</div><div class="line">    <span class="keywordtype">char</span> ready;</div><div class="line">    <span class="keywordtype">char</span> signal;</div><div class="line">    <span class="keywordtype">int</span> J[6];</div><div class="line">    <span class="keywordtype">int</span> C[3];</div><div class="line">} <a class="code" href="structdatastruct.html">datastruct</a>;</div></div><!-- fragment --><h1><a class="anchor" id="Biblioteca_sec"></a>
Biblioteca Criada</h1>
<p>A biblioteca VS_Modbus foi criada de forma a consolidar os conhecimentos apreendidos nas aulas de PARI do ano letivo 2016/2017 sobre criação de bibliotecas dinâmicas. Foi ainda usada como forma de simplificação do código fonte usado no Projeto Final da Unidade Curricular. De entre as funções presentes na biblioteca destacam-se as funções de geração de mensagens modbus que desempenham uma determinada função quando enviadas para o Servidor. A referida biblioteca inclui outras bibliotecas que são necessárias para que as funções sejam executadas sem erros, para se estabelecer a ligação TCP/IP e ainda para manipulação de strigs e sua impressão na linha de comandos. Na biblioteca estão integradas as seguintes funções :</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="myf_8c.html#a2841b922945aeb883c990b0ce0020ff7">GetSharedMem</a> ();</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="callbacks_8c.html#a07d823e45a69fcc54aadf4936d602411">InterceptCTRL_C</a>(<span class="keywordtype">int</span> a);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#afee8206961044bcab4ed309c76f88c0f">VS_Modbus_GtABS</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#af641127a1d5741a716817b420e750c70">VS_Modbus_GtJOI</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#a2945910d2e5f864fd3fdc633fb0ff465">VS_Modbus_GtValues</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#a9c83bef5139c1929d65660a6cc786047">VS_Modbus_Idle</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#a9fc16347faf60490c6e2ab8ff44aee86">VS_Modbus_MSwitch</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus );</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#aeffa8c9c7b39ce3cf017228a9dd3d78f">VS_Modbus_MvABS</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#ac5ddf6b261e198ed004881badc074af3">VS_Modbus_MvJOI</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#a262d1346626115c4ce0b05d0e8c37ac1">VS_Modbus_MvPRG</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus, <span class="keywordtype">char</span> prg);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#a9fb8b5a6432f6bfcfbfc8345ec92f1ce">VS_Modbus_WrABS</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="myf_8c.html#ae4049d0602349aeb55273105d74963c3">VS_Modbus_WrJOI</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="myf_8c.html#a8bf716921ea686a20b38d02ce3397c61">VS_PrintMessages</a>(<span class="keywordtype">char</span> *buf , <span class="keywordtype">int</span> length , <span class="keywordtype">char</span>* type);</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="myf_8c.html#aa5d06594dbe2bc6b9b50d1510dccf898">VS_ReadCoords</a>( <a class="code" href="structdatastruct.html">datastruct</a> *modbus , <span class="keywordtype">char</span> *ibuf );</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="myf_8c.html#ad0d20dfd66d3f22421fa5f187abe45d7">VS_ReadJoints</a> ( <a class="code" href="structdatastruct.html">datastruct</a> *modbus , <span class="keywordtype">char</span> *ibuf );</div></div><!-- fragment --><h1><a class="anchor" id="Futuro_sec"></a>
Trabalhos Futuros</h1>
<pre class="fragment">1 - Instalação do protocolo ModBus TCP/IP no robot Fanuc LR Mate 200iD;
2 - Pequenas alterações no código e nas mensagens ModBus de forma a compatibilizar a aplicação para comunicação com o robot utilizando os registos disponíveis sem comprometer os que estão reservados.
</pre><h1><a class="anchor" id="Agradecimentos_sec"></a>
Agradecimentos</h1>
<ul>
<li>Aos colegas da disciplina por toda a entreajuda, pelos momentos passados no Laboratório de Automação e Robótica e pela moralização nos momentos mais difíceis;</li>
<li>Ao Eng. Rui Cancela da Motofil pelos vários esclarecimentos sobre o protocolo utilizado, pela documentação fornecida e pelas informaçõs acerca dos robôs Fanuc;</li>
<li>Ao docente da disciplina pelo correto ensino da lingugem de Programação C, base de desenvolvimento deste Projeto, e pela disponibilidade para o esclarecimento de dúvidas aos alunos. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
